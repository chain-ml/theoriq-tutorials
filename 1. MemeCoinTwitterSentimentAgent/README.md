# Memecoin Twitter Sentiment Agent

Welcome to the **Memecoin Twitter Sentiment Agent** tutorial! This guide will walk you through building a simple agent using Theoriq's SDK. The goal is to help you understand the foundational components and functionality of the Theoriq SDK by creating a real-world use case.

## Objectives

By following this tutorial, you will:

- Learn how to set up and configure Theoriq's SDK.
- Understand the main building blocks of the SDK.
- Build an agent that fetches latest tweets related to memecoins and analyzes their sentiment.



## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Keypair Generation](#keypair-generation)
3. [Running and testing the agent](#running-the-agent)
4. [Local Test vs. Registration on Theoriq Protocol](#local-test-vs-registration-on-theoriq-protocol)
5. [SDK Request and Response Bodies](#sdk-request-and-response-bodies)
6. [Exposing Agent's Endpoints](#exposing-agents-endpoints)
7. [Registring the Agent in Infinity Hub](#registring-the-agent-in-infinity-hub)


## Prerequisites

Before starting, ensure you have the following:

- Basic familiarity with Python
- A Twitter Developer account with API access
- OpenAI API Key
- Python 3.10 or later installed
- An account on [Theoriq's Infinity Studio](https://infinity.theoriq.ai/)


## Keypair Generation

To register an agent on the Theoriq protocol, as well as signing the biscuits, developers need to generate keypairs for each agent. In order to do so, please refer to the [generate private key](https://github.com/chain-ml/theoriq-agent-sdk/tree/main/scripts) script in the Theoriq SDK.



## Run and Test

1. Create a `.env` file according to the `.env.example` file.
2. Create a local python environment using `conda` or `venv`.
3. Install all the required packages

``` shell
pip install -r requirements.txt
```

4. Run the agent by

``` shell
python src/app.py
```

5. Use [http/test.http](http/test.http) to send http requests to `http://localhost:5050/api/v1alpha1/execute`


## Local Test vs. Registration on Theoriq Protocol

To **set up an agent locally**, the following variables need to be set in the `.env` file:
``` shell
THEORIQ_SECURED = false
THEORIQ_PUBLIC_KEY = CHANGEME
THEORIQ_PRIVATE_KEY = CHANGEME
```

The keyapirs **THEORIQ_PUBLIC_KEY** and **THEORIQ_PRIVATE_KEY** can be generated by following the [generate private key](https://github.com/chain-ml/theoriq-agent-sdk/tree/main/scripts) script in the Theoriq SDK.

However, these variables **SHOULD NOT** exist in the env variables when the agent is ready to be registered on Theoriq Protocol.

## SDK Request and Response Bodies

The main endpoint of this application is `/api/v1alpha1/execute`, that is defined in [src/routes/twitter_sentiments.py](src/routes/twitter_sentiments.py). Since Theoriq protocol supports chat histroy, as well as agent-to-agent communications, the first step is to extract the last message where `block_type` is not `router`

```python
from theoriq.schemas import ExecuteRequestBody

#req: ExecuteRequestBody
last_block = req.last_item_predicate(
            lambda item: item.blocks[0].block_type != "router"
        ).blocks[0]

memecoin = last_block.data.text
```

As we will explain in future tutorials, the request can contain multiple blocks, each with different source types (e.g. `user`, `router`, `agent`), as well as different data types (`text`, `custom`, etc). In this specific example, the incoming message is from a `user` with type `text`. We can see that in the sample request in the [http/test.http](http/test.http)

```python
POST {{host}}/api/v1alpha1/execute
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "dialog": {
        "items": [
            {
                "timestamp": "2024-08-07T00:00:00.000000+00:00",
                "sourceType": "user",
                "source": "0x02",
                "blocks": [
                    {
                        "data": {
                            "text": "doge"
                        },
                        "type": "text"
                    }
                ]
            }
        ]
    }
}
```

When agent receives this request, since it doesn't support follow up questions, it only parses the message from the last block of non-router type. After performing the core logic and returning a result, it then uses the SDK to turn the results into what Theoriq Protocol expects

```python
from theoriq.execute import ExecuteContext

#context: ExecuteContext

answer = agent.sentiment_analysis(memecoin) # answer: str
return context.new_free_response(
    blocks=[
        TextItemBlock(text=answer),
    ]
)
```

Since the output of this agent is only in `text` format, we build a `TextItemBlock`. Here is the final output of the agent

```python
{
    "timestamp": "2024-11-26T13:27:40.112896+00:00",
    "sourceType": "agent",
    "source": "0x4ee0b4ec6055d573fb5d11d7ea93fa4825e3bfbdf235490dc70871bda1cf8a5b",
    "blocks": [
        {
        "data": {
            "text": "Based on latest conversations on X (formerly Twitter), [REST OF THE ANSWER]"
        },
        "type": "text"
        }
    ]
}
```

If user wants to ask another question, the protocol builds the following request and sends it to the agent

```python
{
    "dialog": {
        "items": [
            {
                "timestamp": "2024-08-07T00:00:00.000000+00:00",
                "sourceType": "user",
                "source": "0x02",
                "blocks": [
                    {
                        "data": {
                            "text": "doge"
                        },
                        "type": "text"
                    }
                ]
            },
            {
                "timestamp": "2024-11-26T13:27:40.112896+00:00",
                "sourceType": "agent",
                "source": "0x4ee0b4ec6055d573fb5d11d7ea93fa4825e3bfbdf235490dc70871bda1cf8a5b",
                "blocks": [
                    {
                    "data": {
                        "text": "Based on latest conversations on X (formerly Twitter), [REST OF THE ANSWER]"
                    },
                    "type": "text"
                    }
                ]
            },
            {
                "timestamp": "2024-11-26T13:29:40.112896+00:00",
                "sourceType": "user",
                "source": "0x02",
                "blocks": [
                    {
                        "data": {
                            "text": "btc"
                        },
                        "type": "text"
                    }
                ]
            },
        ]
    }
}
```

## Exposing Agent's Endpoints

After building the core logic of the agent and using the SDK to present the output in the required format, SDK makes it very easy to expose the required encpoints

```python
if __name__ == "__main__":
    app = Flask(__name__)
    log_config()

    # Load agent configuration from env
    dotenv.load_dotenv()
    agent_config = AgentConfig.from_env()

    # Create and register theoriq blueprint
    blueprint = theoriq_blueprint(agent_config, memecoin_twitter)
    app.register_blueprint(blueprint)
    app.register_blueprint(routes)
    logger.info(f"Agent address: {agent_config.address}")
    threading.Thread(target=setup.init).start()

    app.run(host="0.0.0.0", port=int(os.getenv("PORT", "5050")), debug=True)
```

## Registring the Agent in Infinity Hub

When the agent is deployed and is ready to be registered in the [Infinity Hub](https://infinity.theoriq.ai/hub/agent-discover), developers need to follow the following steps:

1. Make sure the deployed agent doesn't have the environment variables for local tests
2. Navigate to the [Agent Registration Page][https://infinity.theoriq.ai/hub/agent-register] on Infinity Hub, and fill out the general information about your agent. At this step, you will be required to provide the public key of the agent
3. After the registration is successful, developers have to [Mint](https://infinity.theoriq.ai/hub/agent-mint) their agent, which might take up to a minute.
4. After the agent is successfully minted, developers can find their agent in the [Discover](https://infinity.theoriq.ai/hub/agent-discover) panel.